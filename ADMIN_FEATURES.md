# 管理员功能说明

本文档说明管理员的高级功能，包括用户删除和邮箱黑名单。

## 🚀 快速开始

### 1. 部署数据库函数

在 Supabase Dashboard 的 SQL Editor 中依次执行：

```bash
# 1. 删除用户功能
backend/sql/12_delete_user_function.sql

# 2. 邮箱黑名单功能
backend/sql/13_email_blacklist.sql
```

或使用 Supabase CLI：
```bash
cd backend
supabase db push
```

### 2. 验证部署

```sql
-- 检查函数是否创建成功
SELECT routine_name, routine_type
FROM information_schema.routines
WHERE routine_schema = 'public'
  AND routine_name IN (
    'delete_user_completely',
    'get_user_file_paths',
    'add_email_to_blacklist',
    'remove_email_from_blacklist',
    'batch_add_emails_to_blacklist',
    'check_email_before_signup',
    'get_blacklist_stats'
  );
```

应该返回 7 个函数记录。

### 3. 设置超级管理员

```sql
-- 将第一个用户设置为超级管理员
SELECT set_first_user_as_super_admin();

-- 或手动设置指定用户
UPDATE user_profiles 
SET role = 'super_admin' 
WHERE id = 'your-user-id';
```

## 📋 功能清单

### 1️⃣ 删除用户功能

#### 功能说明
- ✅ 完全删除用户账户
- ✅ 清理所有文件（Storage + 数据库）
- ✅ 删除分享链接
- ✅ 删除活动日志
- ✅ 删除文件夹
- ✅ 二次确认机制

#### 使用方式
1. 以超级管理员身份登录
2. 进入管理后台 → 用户管理
3. 找到要删除的用户
4. 点击 🗑️ 删除按钮
5. 确认删除操作
6. 输入用户邮箱验证

#### 权限要求
- 🔒 仅超级管理员可用
- 🔒 不能删除自己
- 🔒 不能删除其他超级管理员

#### 详细文档
📄 [查看完整文档](./backend/sql/README_DELETE_USER.md)

---

### 2️⃣ 邮箱黑名单功能

#### 功能说明
- ✅ 添加/移除黑名单邮箱
- ✅ 批量添加邮箱
- ✅ 自动拦截注册
- ✅ 统计信息展示
- ✅ 操作历史记录

#### 使用方式

**添加单个邮箱**
1. 进入管理后台 → 邮箱黑名单
2. 点击 ➕ 添加邮箱
3. 输入邮箱地址
4. 填写拉黑原因（可选）
5. 确认添加

**批量添加邮箱**
1. 点击 📋 批量添加
2. 输入邮箱列表（每行一个）
3. 填写拉黑原因
4. 确认添加

**移除黑名单**
1. 找到要移除的邮箱
2. 点击 ✖️ 移除按钮
3. 确认操作

#### 权限要求
- 🔒 管理员和超级管理员可管理
- 🔓 注册时自动检查（无需权限）

#### 注册拦截
用户注册时会自动检查黑名单：
- ✅ 不在黑名单：允许注册
- ❌ 在黑名单：显示提示并阻止

#### 详细文档
📄 [查看完整文档](./backend/sql/README_BLACKLIST.md)

---

## 🎯 常见使用场景

### 场景1：处理恶意用户

1. **发现恶意行为**
   - 在用户管理中发现可疑用户

2. **删除用户**
   - 点击删除按钮
   - 确认并清理所有数据

3. **拉黑邮箱**
   - 在黑名单中添加该邮箱
   - 填写原因："恶意盗刷资源"

4. **防止再次注册**
   - 该邮箱无法再次注册

### 场景2：批量防护

1. **收集恶意邮箱列表**
   ```
   spam1@temp-mail.com
   spam2@temp-mail.com
   spam3@temp-mail.com
   ```

2. **批量拉黑**
   - 使用批量添加功能
   - 一次性添加所有邮箱

3. **监控效果**
   - 查看统计信息
   - 关注注册失败日志

### 场景3：误删恢复

1. **用户反馈无法注册**
   - 检查是否在黑名单中

2. **确认误拉黑**
   - 查看拉黑原因和时间

3. **移除黑名单**
   - 点击移除按钮
   - 通知用户重新注册

## 🔐 安全机制

### 权限分级
```
超级管理员 (super_admin)
  ├── 删除用户 ✅
  ├── 管理黑名单 ✅
  └── 所有管理功能 ✅

管理员 (admin)
  ├── 删除用户 ❌
  ├── 管理黑名单 ✅
  └── 部分管理功能 ✅

普通用户 (user)
  ├── 删除用户 ❌
  ├── 管理黑名单 ❌
  └── 基础功能 ✅
```

### 多重保护
- ✅ 数据库函数权限检查
- ✅ RLS 策略保护
- ✅ 前端界面权限控制
- ✅ 二次确认机制
- ✅ 操作日志记录

### 防误操作
- ✅ 不能删除自己
- ✅ 不能删除超级管理员
- ✅ 需要输入邮箱确认
- ✅ 详细的警告提示

## 📊 统计和监控

### 黑名单统计
- 总数量
- 今日新增
- 本周新增

### 用户统计
- 总用户数
- 活跃用户数
- 管理员数量

### 建议监控指标
- 每日删除用户数
- 黑名单增长趋势
- 注册失败次数
- 可疑活动模式

## 🛠️ 故障排查

### 问题：无法删除用户

**检查清单**
1. ✅ 是否是超级管理员？
2. ✅ 是否在尝试删除自己？
3. ✅ SQL函数是否部署？
4. ✅ 是否有网络错误？

**解决方案**
```sql
-- 检查当前用户角色
SELECT role FROM user_profiles WHERE id = auth.uid();

-- 验证函数存在
SELECT routine_name FROM information_schema.routines
WHERE routine_name = 'delete_user_completely';
```

### 问题：黑名单不生效

**检查清单**
1. ✅ SQL函数是否部署？
2. ✅ 前端代码是否更新？
3. ✅ 邮箱格式是否正确？
4. ✅ 是否清除浏览器缓存？

**解决方案**
```sql
-- 手动检查邮箱
SELECT is_email_blacklisted('test@example.com');

-- 查看黑名单列表
SELECT * FROM email_blacklist;
```

## 📱 移动端支持

两个功能都完全支持移动端：

### 用户管理
- ✅ 卡片式布局
- ✅ 触控友好的按钮
- ✅ 完整的操作功能

### 黑名单管理
- ✅ 响应式设计
- ✅ 易于操作的界面
- ✅ 统计信息展示

## 🔄 更新日志

### v1.0.0 (2024)

**新增功能**
- ✅ 删除用户功能
- ✅ 邮箱黑名单功能
- ✅ 移动端适配
- ✅ 批量操作支持

**安全改进**
- ✅ 多重权限检查
- ✅ 二次确认机制
- ✅ 操作日志记录

**性能优化**
- ✅ 数据库索引优化
- ✅ 批量操作优化
- ✅ 查询性能提升

## 📚 相关文档

- [删除用户功能详细说明](./backend/sql/README_DELETE_USER.md)
- [邮箱黑名单详细说明](./backend/sql/README_BLACKLIST.md)
- [数据库表结构](./backend/sql/04_user_management.sql)
- [RLS 策略](./backend/sql/02_rls.sql)

## 🤝 技术支持

遇到问题？

1. 📖 查看详细文档
2. 🔍 检查故障排查部分
3. 🐛 查看浏览器控制台
4. 📝 查看服务器日志
5. 💬 联系技术支持

## ⚠️ 重要提示

1. **删除操作不可逆**
   - 删除前务必确认
   - 建议定期备份数据

2. **谨慎使用批量操作**
   - 批量拉黑前仔细检查
   - 避免误伤正常用户

3. **定期审查**
   - 定期检查黑名单合理性
   - 清理无效的黑名单记录

4. **权限管理**
   - 谨慎授予超级管理员权限
   - 定期审查管理员账户

## 📝 最佳实践

### ✅ 推荐做法
- 删除用户前先查看其活动
- 拉黑时填写详细原因
- 定期审查黑名单
- 保持操作日志

### ❌ 避免做法
- 不要随意删除用户
- 不要批量拉黑常见域名
- 不要忘记通知用户
- 不要长期保留无效黑名单

---

**最后更新**: 2024
**版本**: 1.0.0
**维护者**: 系统管理员
