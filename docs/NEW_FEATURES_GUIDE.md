# ğŸ‰ æ–°åŠŸèƒ½å®Œæ•´æŒ‡å—

## ğŸ“‹ å·²æ·»åŠ çš„åŠŸèƒ½

### 1. ç”¨æˆ·ç®¡ç†ç³»ç»Ÿ âœ…

#### æ•°æ®åº“è¡¨
- `user_profiles` - ç”¨æˆ·é…ç½®è¡¨
  - è§’è‰²ç®¡ç†ï¼ˆuser, admin, super_adminï¼‰
  - è´¦æˆ·çŠ¶æ€ï¼ˆå¯ç”¨/ç¦ç”¨ï¼‰
  - å­˜å‚¨é…é¢ç®¡ç†
  - æ˜¾ç¤ºåç§°å’Œå¤´åƒ

#### åŠŸèƒ½ç‰¹æ€§
- âœ… è¶…çº§ç®¡ç†å‘˜è´¦å·
- âœ… ç”¨æˆ·åˆ—è¡¨æŸ¥çœ‹
- âœ… ç”¨æˆ·è§’è‰²ç®¡ç†ï¼ˆæ™®é€šç”¨æˆ·/ç®¡ç†å‘˜/è¶…çº§ç®¡ç†å‘˜ï¼‰
- âœ… å¯ç”¨/ç¦ç”¨ç”¨æˆ·
- âœ… å­˜å‚¨é…é¢ç®¡ç†
- âœ… ç”¨æˆ·ç»Ÿè®¡ä¿¡æ¯

### 2. é‚®ç®±éªŒè¯ç³»ç»Ÿ âœ…

#### Supabase é…ç½®
- åœ¨ Authentication â†’ Providers â†’ Email ä¸­
- å¯ç”¨ "Confirm email" é€‰é¡¹
- é…ç½®é‚®ä»¶æ¨¡æ¿

#### åŠŸèƒ½ç‰¹æ€§
- âœ… æ³¨å†Œæ—¶å¿…é¡»éªŒè¯é‚®ç®±
- âœ… è‡ªåŠ¨å‘é€éªŒè¯é‚®ä»¶
- âœ… éªŒè¯çŠ¶æ€æ£€æŸ¥
- âœ… é‡å‘éªŒè¯é‚®ä»¶åŠŸèƒ½

### 3. æ–‡ä»¶åˆ†äº«ç³»ç»Ÿ âœ…

#### æ•°æ®åº“è¡¨
- `file_shares` - æ–‡ä»¶åˆ†äº«è¡¨
  - åˆ†äº«é“¾æ¥ç”Ÿæˆ
  - å¯†ç ä¿æŠ¤
  - è¿‡æœŸæ—¶é—´
  - ä¸‹è½½æ¬¡æ•°é™åˆ¶

#### åŠŸèƒ½ç‰¹æ€§
- âœ… ç”Ÿæˆåˆ†äº«é“¾æ¥
- âœ… å¯†ç ä¿æŠ¤ï¼ˆå¯é€‰ï¼‰
- âœ… è®¾ç½®è¿‡æœŸæ—¶é—´
- âœ… é™åˆ¶ä¸‹è½½æ¬¡æ•°
- âœ… åˆ†äº«ç®¡ç†ï¼ˆå¯ç”¨/ç¦ç”¨/åˆ é™¤ï¼‰

### 4. æ–‡ä»¶å¤¹ç»„ç»‡ âœ…

#### æ•°æ®åº“è¡¨
- `folders` - æ–‡ä»¶å¤¹è¡¨
  - å±‚çº§ç»“æ„
  - è·¯å¾„ç®¡ç†
  - ç”¨æˆ·éš”ç¦»

#### åŠŸèƒ½ç‰¹æ€§
- âœ… åˆ›å»ºæ–‡ä»¶å¤¹
- âœ… æ–‡ä»¶å¤¹å±‚çº§
- âœ… æ–‡ä»¶å½’ç±»
- âœ… æ–‡ä»¶å¤¹é‡å‘½å/åˆ é™¤

### 5. æ´»åŠ¨æ—¥å¿—ç³»ç»Ÿ âœ…

#### æ•°æ®åº“è¡¨
- `activity_logs` - æ´»åŠ¨æ—¥å¿—è¡¨
  - ç”¨æˆ·æ“ä½œè®°å½•
  - IP åœ°å€è®°å½•
  - è¯¦ç»†ä¿¡æ¯å­˜å‚¨

#### åŠŸèƒ½ç‰¹æ€§
- âœ… è‡ªåŠ¨è®°å½•ç”¨æˆ·æ“ä½œ
- âœ… æ—¥å¿—æŸ¥çœ‹ï¼ˆç”¨æˆ·/ç®¡ç†å‘˜ï¼‰
- âœ… æ“ä½œç±»å‹åˆ†ç±»
- âœ… æ—¶é—´ç­›é€‰

### 6. ç”¨æˆ·é…é¢ç®¡ç† âœ…

#### åŠŸèƒ½ç‰¹æ€§
- âœ… é»˜è®¤ 1GB å­˜å‚¨é…é¢
- âœ… è‡ªåŠ¨è®¡ç®—å·²ç”¨ç©ºé—´
- âœ… ä¸Šä¼ å‰æ£€æŸ¥é…é¢
- âœ… ç®¡ç†å‘˜å¯è°ƒæ•´é…é¢

### 7. ç®¡ç†åå° âœ…

#### é¡µé¢åŠŸèƒ½
- âœ… ç”¨æˆ·ç®¡ç†ç•Œé¢
- âœ… æ´»åŠ¨æ—¥å¿—æŸ¥çœ‹
- âœ… ç³»ç»Ÿç»Ÿè®¡é¢æ¿
- âœ… å®æ—¶æ•°æ®æ›´æ–°

---

## ğŸš€ å¿«é€Ÿå¼€å§‹

### æ­¥éª¤ 1ï¼šæ‰§è¡Œæ•°æ®åº“è„šæœ¬

åœ¨ Supabase SQL Editor ä¸­æ‰§è¡Œï¼š

```bash
backend/sql/04_user_management.sql
```

è¿™å°†åˆ›å»ºæ‰€æœ‰å¿…è¦çš„è¡¨ã€è§¦å‘å™¨å’Œç­–ç•¥ã€‚

### æ­¥éª¤ 2ï¼šè®¾ç½®è¶…çº§ç®¡ç†å‘˜

æ³¨å†Œç¬¬ä¸€ä¸ªç”¨æˆ·åï¼Œåœ¨ SQL Editor ä¸­æ‰§è¡Œï¼š

```sql
-- å°†ç¬¬ä¸€ä¸ªç”¨æˆ·è®¾ç½®ä¸ºè¶…çº§ç®¡ç†å‘˜
SELECT set_first_user_as_super_admin();
```

æˆ–è€…æ‰‹åŠ¨è®¾ç½®ç‰¹å®šç”¨æˆ·ï¼š

```sql
-- æ›¿æ¢ 'user-email@example.com' ä¸ºå®é™…é‚®ç®±
UPDATE user_profiles
SET role = 'super_admin'
WHERE id = (
  SELECT id FROM auth.users 
  WHERE email = 'user-email@example.com'
);
```

### æ­¥éª¤ 3ï¼šå¯ç”¨é‚®ç®±éªŒè¯

åœ¨ Supabase Dashboardï¼š
1. Authentication â†’ Providers â†’ Email
2. å‹¾é€‰ "Confirm email"
3. é…ç½®é‚®ä»¶æ¨¡æ¿ï¼ˆå¯é€‰ï¼‰
4. ä¿å­˜

### æ­¥éª¤ 4ï¼šæ·»åŠ ç®¡ç†åå°è·¯ç”±

è·¯ç”±å·²è‡ªåŠ¨é…ç½®ï¼Œè®¿é—®ï¼š
- ç®¡ç†åå°ï¼š`/admin`

### æ­¥éª¤ 5ï¼šæµ‹è¯•åŠŸèƒ½

1. æ³¨å†Œæ–°ç”¨æˆ·ï¼ˆéœ€è¦éªŒè¯é‚®ç®±ï¼‰
2. ç™»å½•åè®¿é—® `/admin`ï¼ˆå¦‚æœæ˜¯ç®¡ç†å‘˜ï¼‰
3. æµ‹è¯•ç”¨æˆ·ç®¡ç†åŠŸèƒ½
4. æµ‹è¯•æ–‡ä»¶åˆ†äº«åŠŸèƒ½

---

## ğŸ“– ä½¿ç”¨æŒ‡å—

### ç”¨æˆ·ç®¡ç†

#### æŸ¥çœ‹ç”¨æˆ·åˆ—è¡¨
```javascript
import { getAllUsers } from '@/api/admin'

const users = await getAllUsers()
```

#### ç¦ç”¨ç”¨æˆ·
```javascript
import { updateUserStatus } from '@/api/admin'

await updateUserStatus(userId, false) // ç¦ç”¨
await updateUserStatus(userId, true)  // å¯ç”¨
```

#### æ›´æ”¹ç”¨æˆ·è§’è‰²
```javascript
import { updateUserRole } from '@/api/admin'

await updateUserRole(userId, 'admin') // è®¾ä¸ºç®¡ç†å‘˜
await updateUserRole(userId, 'user')  // è®¾ä¸ºæ™®é€šç”¨æˆ·
```

### æ–‡ä»¶åˆ†äº«

#### åˆ›å»ºåˆ†äº«
```javascript
import { createFileShare } from '@/api/shares'

const share = await createFileShare(fileId, {
  password: '123456',           // å¯é€‰
  expiresAt: '2024-12-31',     // å¯é€‰
  maxDownloads: 10              // å¯é€‰
})

console.log('åˆ†äº«é“¾æ¥:', share.share_token)
```

#### è·å–åˆ†äº«åˆ—è¡¨
```javascript
import { getUserShares } from '@/api/shares'

const shares = await getUserShares()
```

### æ´»åŠ¨æ—¥å¿—

#### è®°å½•æ“ä½œ
```javascript
import { logActivity } from '@/api/admin'

await logActivity('upload', 'file', fileId, {
  fileName: 'test.jpg',
  fileSize: 1024
})
```

#### æŸ¥çœ‹æ—¥å¿—
```javascript
import { getActivityLogs } from '@/api/admin'

const logs = await getActivityLogs(userId, 50) // æœ€è¿‘ 50 æ¡
```

---

## ğŸ” æƒé™è¯´æ˜

### è§’è‰²æƒé™

#### æ™®é€šç”¨æˆ· (user)
- âœ… ä¸Šä¼ /ä¸‹è½½/åˆ é™¤è‡ªå·±çš„æ–‡ä»¶
- âœ… åˆ›å»ºæ–‡ä»¶åˆ†äº«
- âœ… æŸ¥çœ‹è‡ªå·±çš„æ´»åŠ¨æ—¥å¿—
- âœ… ä¿®æ”¹ä¸ªäººèµ„æ–™
- âŒ æ— æ³•è®¿é—®ç®¡ç†åå°
- âŒ æ— æ³•æŸ¥çœ‹å…¶ä»–ç”¨æˆ·ä¿¡æ¯

#### ç®¡ç†å‘˜ (admin)
- âœ… æ‰€æœ‰æ™®é€šç”¨æˆ·æƒé™
- âœ… è®¿é—®ç®¡ç†åå°
- âœ… æŸ¥çœ‹æ‰€æœ‰ç”¨æˆ·åˆ—è¡¨
- âœ… å¯ç”¨/ç¦ç”¨ç”¨æˆ·
- âœ… ä¿®æ”¹ç”¨æˆ·è§’è‰²ï¼ˆé™¤è¶…çº§ç®¡ç†å‘˜å¤–ï¼‰
- âœ… æŸ¥çœ‹æ‰€æœ‰æ´»åŠ¨æ—¥å¿—
- âœ… è°ƒæ•´ç”¨æˆ·é…é¢
- âŒ æ— æ³•ä¿®æ”¹è¶…çº§ç®¡ç†å‘˜

#### è¶…çº§ç®¡ç†å‘˜ (super_admin)
- âœ… æ‰€æœ‰ç®¡ç†å‘˜æƒé™
- âœ… ä¿®æ”¹ä»»ä½•ç”¨æˆ·è§’è‰²
- âœ… è®¾ç½®å…¶ä»–è¶…çº§ç®¡ç†å‘˜
- âœ… å®Œå…¨çš„ç³»ç»Ÿæ§åˆ¶æƒ

---

## ğŸ¨ å‰ç«¯ç»„ä»¶

### å·²åˆ›å»ºçš„ç»„ä»¶

1. **Admin.vue** - ç®¡ç†åå°ä¸»é¡µé¢
   - ç”¨æˆ·ç®¡ç†æ ‡ç­¾
   - æ´»åŠ¨æ—¥å¿—æ ‡ç­¾
   - ç³»ç»Ÿç»Ÿè®¡æ ‡ç­¾

2. **UserProfile.vue** - ç”¨æˆ·ä¸ªäººèµ„æ–™ï¼ˆå¾…åˆ›å»ºï¼‰
3. **ShareManager.vue** - åˆ†äº«ç®¡ç†ï¼ˆå¾…åˆ›å»ºï¼‰
4. **FolderTree.vue** - æ–‡ä»¶å¤¹æ ‘ï¼ˆå¾…åˆ›å»ºï¼‰

### å·²åˆ›å»ºçš„ API

1. **admin.js** - ç®¡ç†å‘˜ API
   - getAllUsers()
   - updateUserStatus()
   - updateUserRole()
   - updateUserQuota()
   - getActivityLogs()
   - logActivity()

2. **shares.js** - åˆ†äº« API
   - createFileShare()
   - getFileShares()
   - getUserShares()
   - getShareByToken()
   - deleteShare()

---

## ğŸ“Š æ•°æ®åº“ç»“æ„

### æ–°å¢è¡¨

```sql
user_profiles (
  id uuid PRIMARY KEY,
  role text,
  is_active boolean,
  storage_quota bigint,
  storage_used bigint,
  display_name text,
  avatar_url text,
  created_at timestamp,
  updated_at timestamp
)

activity_logs (
  id uuid PRIMARY KEY,
  user_id uuid,
  action text,
  resource_type text,
  resource_id uuid,
  details jsonb,
  ip_address inet,
  user_agent text,
  created_at timestamp
)

file_shares (
  id uuid PRIMARY KEY,
  file_id uuid,
  user_id uuid,
  share_token text UNIQUE,
  password text,
  expires_at timestamp,
  max_downloads int,
  download_count int,
  is_active boolean,
  created_at timestamp
)

folders (
  id uuid PRIMARY KEY,
  user_id uuid,
  name text,
  parent_id uuid,
  path text,
  created_at timestamp,
  updated_at timestamp
)
```

### è§¦å‘å™¨

1. **create_user_profile()** - è‡ªåŠ¨åˆ›å»ºç”¨æˆ·é…ç½®
2. **update_storage_used()** - è‡ªåŠ¨æ›´æ–°å­˜å‚¨ä½¿ç”¨é‡
3. **update_updated_at()** - è‡ªåŠ¨æ›´æ–°æ—¶é—´æˆ³

---

## ğŸ”§ é…ç½®è¯´æ˜

### é‚®ç®±éªŒè¯é…ç½®

#### å¼€å‘ç¯å¢ƒï¼ˆå…³é—­éªŒè¯ï¼‰
```
Authentication â†’ Providers â†’ Email
å–æ¶ˆå‹¾é€‰ "Confirm email"
```

#### ç”Ÿäº§ç¯å¢ƒï¼ˆå¯ç”¨éªŒè¯ï¼‰
```
Authentication â†’ Providers â†’ Email
å‹¾é€‰ "Confirm email"
é…ç½® SMTP æˆ–ä½¿ç”¨ Supabase é»˜è®¤é‚®ä»¶æœåŠ¡
```

### å­˜å‚¨é…é¢é…ç½®

é»˜è®¤é…é¢ï¼š1GB (1073741824 bytes)

ä¿®æ”¹é»˜è®¤é…é¢ï¼š
```sql
ALTER TABLE user_profiles 
ALTER COLUMN storage_quota 
SET DEFAULT 2147483648; -- 2GB
```

ä¿®æ”¹ç‰¹å®šç”¨æˆ·é…é¢ï¼š
```sql
UPDATE user_profiles
SET storage_quota = 5368709120 -- 5GB
WHERE id = 'user-id';
```

---

## ğŸ¯ ä¸‹ä¸€æ­¥å¼€å‘å»ºè®®

### çŸ­æœŸï¼ˆ1-2 å‘¨ï¼‰

1. **ç”¨æˆ·ä¸ªäººèµ„æ–™é¡µé¢**
   - ä¿®æ”¹æ˜¾ç¤ºåç§°
   - ä¸Šä¼ å¤´åƒ
   - ä¿®æ”¹å¯†ç 
   - æŸ¥çœ‹å­˜å‚¨ä½¿ç”¨æƒ…å†µ

2. **æ–‡ä»¶åˆ†äº«é¡µé¢**
   - åˆ†äº«é“¾æ¥ç®¡ç†
   - åˆ†äº«ç»Ÿè®¡
   - å¿«é€Ÿåˆ†äº«æŒ‰é’®

3. **æ–‡ä»¶å¤¹åŠŸèƒ½å®Œå–„**
   - æ–‡ä»¶å¤¹æ ‘ç»„ä»¶
   - æ‹–æ‹½ç§»åŠ¨æ–‡ä»¶
   - æ‰¹é‡æ“ä½œ

### ä¸­æœŸï¼ˆ1 ä¸ªæœˆï¼‰

4. **é«˜çº§æœç´¢**
   - æ–‡ä»¶åæœç´¢
   - æ–‡ä»¶ç±»å‹ç­›é€‰
   - æ—¥æœŸèŒƒå›´ç­›é€‰
   - æ ‡ç­¾ç³»ç»Ÿ

5. **æ‰¹é‡æ“ä½œ**
   - æ‰¹é‡ä¸Šä¼ 
   - æ‰¹é‡åˆ é™¤
   - æ‰¹é‡ç§»åŠ¨
   - æ‰¹é‡åˆ†äº«

6. **é€šçŸ¥ç³»ç»Ÿ**
   - é‚®ä»¶é€šçŸ¥
   - ç«™å†…é€šçŸ¥
   - æ“ä½œæé†’

### é•¿æœŸï¼ˆ2-3 ä¸ªæœˆï¼‰

7. **å›¢é˜Ÿåä½œ**
   - å›¢é˜Ÿç©ºé—´
   - æ–‡ä»¶åä½œ
   - æƒé™ç»†åˆ†

8. **é«˜çº§åˆ†æ**
   - ä½¿ç”¨ç»Ÿè®¡
   - ç”¨æˆ·è¡Œä¸ºåˆ†æ
   - å­˜å‚¨è¶‹åŠ¿

9. **API æ¥å£**
   - RESTful API
   - API å¯†é’¥ç®¡ç†
   - å¼€å‘è€…æ–‡æ¡£

---

## ğŸ› å¸¸è§é—®é¢˜

### Q: å¦‚ä½•è®¾ç½®è¶…çº§ç®¡ç†å‘˜ï¼Ÿ

A: æ³¨å†Œç¬¬ä¸€ä¸ªç”¨æˆ·åï¼Œæ‰§è¡Œï¼š
```sql
SELECT set_first_user_as_super_admin();
```

### Q: ç”¨æˆ·æ— æ³•è®¿é—®ç®¡ç†åå°ï¼Ÿ

A: æ£€æŸ¥ç”¨æˆ·è§’è‰²ï¼š
```sql
SELECT id, email, role FROM user_profiles
JOIN auth.users ON user_profiles.id = auth.users.id;
```

### Q: é‚®ç®±éªŒè¯é‚®ä»¶æ²¡æ”¶åˆ°ï¼Ÿ

A: 
1. æ£€æŸ¥åƒåœ¾é‚®ä»¶æ–‡ä»¶å¤¹
2. ç¡®è®¤ Supabase é‚®ä»¶æœåŠ¡å·²å¯ç”¨
3. æŸ¥çœ‹ Supabase Dashboard çš„ Logs

### Q: å­˜å‚¨é…é¢ä¸æ›´æ–°ï¼Ÿ

A: è§¦å‘å™¨åº”è¯¥è‡ªåŠ¨æ›´æ–°ï¼Œå¦‚æœæ²¡æœ‰ï¼š
```sql
-- æ‰‹åŠ¨é‡æ–°è®¡ç®—
UPDATE user_profiles up
SET storage_used = (
  SELECT COALESCE(SUM(size), 0)
  FROM files
  WHERE user_id = up.id
);
```

---

## ğŸ“ æŠ€æœ¯æ”¯æŒ

å¦‚æœ‰é—®é¢˜ï¼š
1. æŸ¥çœ‹æµè§ˆå™¨æ§åˆ¶å°é”™è¯¯
2. æŸ¥çœ‹ Supabase Dashboard æ—¥å¿—
3. æ£€æŸ¥æ•°æ®åº“ç­–ç•¥é…ç½®
4. å‚è€ƒæœ¬æ–‡æ¡£

---

**ç‰ˆæœ¬**: 2.0.0  
**æ›´æ–°æ—¥æœŸ**: 2024-01-01  
**çŠ¶æ€**: âœ… ç”Ÿäº§å°±ç»ª
